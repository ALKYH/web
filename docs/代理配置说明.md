# 前端代理配置说明

## 概述
本项目配置了多种代理方案来解决前后端跨域问题，支持开发环境和生产环境的不同需求。

## 配置方案

### 方案1：API路由代理（推荐）
- **文件**: `app/api/proxy/[...path]/route.ts`
- **适用**: 开发环境和生产环境（Vercel HTTPS环境）
- **特点**: 完全可控，解决HTTPS混合内容问题，支持自定义逻辑

### 方案2：Next.js内置代理（开发环境）
- **文件**: `next.config.ts`
- **适用**: 纯开发环境（HTTP）
- **特点**: 简单高效，无需额外代码

### 方案3：Vercel平台代理（不推荐）
- **原因**: HTTPS环境不支持HTTP重写，会导致混合内容错误
- **替代**: 使用API路由代理

## 环境变量配置

### 开发环境
创建 `.env.local` 文件：
```bash
# 开发环境配置
NEXT_PUBLIC_API_BASE_URL=/api
NEXT_PUBLIC_BACKEND_URL=http://123.57.174.186:8000
```

### 生产环境
在Vercel环境变量中设置：
```bash
NEXT_PUBLIC_API_BASE_URL=/api
NEXT_PUBLIC_BACKEND_URL=http://123.57.174.186:8000
```

## 使用方法

### 1. 开发环境启动
```bash
npm run dev
```
访问 `http://localhost:3000`，所有 `/api/*` 请求会自动代理到后端服务器。

### 2. Vercel 生产环境部署

#### 方法一：Git 自动部署（推荐）
```bash
# 1. 提交代码
git add vercel.json
git commit -m "添加 Vercel 代理配置"
git push origin main

# 2. Vercel 会自动检测并部署
# 3. 在 Vercel 控制台查看部署状态
```

#### 方法二：Vercel CLI 部署
```bash
# 1. 安装 Vercel CLI
npm i -g vercel

# 2. 登录 Vercel
vercel login

# 3. 部署项目
vercel --prod

# 4. 验证代理配置
npm run verify-proxy
```

#### 方法三：Vercel 控制台部署
1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 点击 "New Project"
3. 连接你的 Git 仓库
4. 在 "Build and Output Settings" 中确认配置
5. 点击 "Deploy"

### 3. 验证代理配置
```bash
# 运行代理验证脚本
npm run verify-proxy
```

### 4. 在 Vercel 控制台检查配置
1. 进入项目设置
2. 查看 "Functions" 标签页
3. 检查 "Rewrites and Redirects" 配置
4. 确认 `vercel.json` 配置已生效

## API调用示例

```typescript
// 使用配置的API端点
import { API_CONFIG, getFullUrl } from '@/app/_lib/api-config';

// 登录请求
const loginUrl = getFullUrl(API_CONFIG.ENDPOINTS.AUTH.LOGIN);
// 实际请求: /api/v1/auth/login
// 代理到: http://123.57.174.186:8000/api/v1/auth/login

// 获取用户信息
const userUrl = getFullUrl(API_CONFIG.ENDPOINTS.USERS.ME);
// 实际请求: /api/v1/users/me
// 代理到: http://123.57.174.186:8000/api/v1/users/me
```

## 故障排除

### 1. 代理不生效
- 检查 `next.config.ts` 配置是否正确
- 确认后端服务器 `http://123.57.174.186:8000` 可访问
- 重启开发服务器

### 2. CORS错误
- 检查 `vercel.json` 中的CORS头配置
- 确认后端服务器CORS配置

### 3. 生产环境问题
- 检查Vercel环境变量设置
- 查看Vercel部署日志
- 确认 `vercel.json` 配置正确

## 故障排除

### 混合内容错误 (Mixed Content)
**问题**: `Mixed Content: The page was loaded over HTTPS, but requested an insecure resource`

**原因**: Vercel是HTTPS环境，但代理配置指向HTTP后端

**解决方案**:
1. ✅ **推荐**: 使用API路由代理 (`app/api/proxy/[...path]/route.ts`)
2. ❌ **避免**: 在`vercel.json`中使用HTTP重写
3. 🔄 **替代**: 升级后端到HTTPS（如果可能）

### 代理请求失败
**检查步骤**:
1. 确认后端服务器可访问: `http://123.57.174.186:8000/`
2. 检查API路由代理文件是否存在
3. 查看Vercel函数日志
4. 运行测试脚本: `npm run verify-proxy`

### CORS错误
**解决方案**:
- 确保`vercel.json`和`next.config.ts`中配置了正确的CORS头
- API路由代理已自动处理CORS

## 注意事项

1. **HTTPS混合内容问题**: Vercel强制HTTPS，如果后端不支持HTTPS，必须使用API路由代理而不是重写规则
2. **安全性**: 生产环境建议使用HTTPS后端URL
3. **性能**: API路由代理会增加请求延迟，建议优化后端响应时间
4. **监控**: 建议添加代理请求的监控和日志
5. **缓存**: 可考虑在代理层添加缓存机制

## 更新日志

- 2024-01-XX: 初始配置，支持基础代理功能
- 2024-01-XX: 添加CORS头配置
- 2024-01-XX: 优化错误处理和日志记录
