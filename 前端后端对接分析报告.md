# 🔗 PeerPortal 前端后端接口对接分析报告

## 📊 **对接现状概览**

### ✅ **已实现的接口模块**

- **认证系统** (`/api/v1/auth`) - ✅ 90% 完成
- **用户管理** (`/api/v1/users`) - ✅ 80% 完成
- **论坛系统** (`/api/v1/forum`) - ✅ 95% 完成
- **消息系统** (`/api/v1/messages`) - ✅ 70% 完成

### ❌ **完全缺失的核心模块**

- **🤖 AI智能体系统 v2.0** (`/api/v2/agents`) - ❌ **0%**
- **🎯 智能匹配系统** (`/api/v1/matching`) - ❌ **0%**
- **📁 文件上传系统** (`/api/v1/files`) - ❌ **0%**

### ⚠️ **部分实现的模块**

- **学长学姐管理** (`/api/v1/mentors`) - ⚠️ 40% 完成
- **学弟学妹管理** (`/api/v1/students`) - ⚠️ 30% 完成
- **指导服务管理** (`/api/v1/services`) - ⚠️ 20% 完成
- **会话管理** (`/api/v1/sessions`) - ⚠️ 30% 完成
- **评价系统** (`/api/v1/reviews`) - ⚠️ 20% 完成

---

## 🚨 **重大缺失详细分析**

### 1. 🤖 **AI智能体系统 v2.0** - **最高优先级**

#### 缺失接口：

```typescript
// 完全缺失 - 这是系统核心功能！ 
/api/2v /
  agents /
  status / // 系统状态
  api /
  v2 /
  agents /
  info / // 架构信息
  api /
  v2 /
  agents /
  health / // 健康检查
  api /
  v2 /
  agents /
  planner /
  chat / // 留学规划师对话 ⭐️
  api /
  v2 /
  agents /
  consultant /
  chat / // 留学咨询师对话 ⭐️
  api /
  v2 /
  agents /
  chat; // 智能体自动选择
```

#### 影响：

- **无法使用AI智能体功能** - 这是平台的核心卖点
- 前端当前使用的是过时的 `/api/v1/planner/invoke`
- 用户无法体验留学规划师和咨询师功能

### 2. 🎯 **智能匹配系统** - **高优先级**

#### 缺失接口：

```typescript
/api/1v /
  matching /
  recommend / // 推荐引路人 ⭐️
  api /
  v1 /
  matching /
  filters / // 获取筛选条件
  api /
  v1 /
  matching /
  filter / // 高级筛选
  api /
  v1 /
  matching /
  history / // 匹配历史
  api /
  v1 /
  matching /
  save / // 保存匹配结果
  api /
  v1 /
  matching /
  saved / // 获取收藏的匹配
  api /
  v1 /
  matching /
  stats / // 匹配统计
  api /
  v1 /
  matching /
  compatibility; // 兼容性检查
```

#### 影响：

- **无法实现智能匹配功能**
- 申请者无法找到合适的引路人
- 缺失核心业务逻辑

### 3. 📁 **文件上传系统** - **中等优先级**

#### 缺失接口：

```typescript
/api/1v /
  files /
  upload /
  avatar / // 上传头像
  api /
  v1 /
  files /
  upload /
  document / // 上传文档
  api /
  v1 /
  files /
  upload /
  general / // 通用文件上传
  api /
  v1 /
  files /
  { file_id }; // 删除文件
```

#### 影响：

- 用户无法上传头像和申请文档
- 无法实现文件管理功能

---

## 🔧 **缺失接口实现方案**

### 方案一：快速修复核心功能

#### 1. **AI智能体 v2.0 API客户端**

```typescript
// web/app/_lib/ai-agent-api.ts
export interface ChatRequest {
  message: string;
  user_id: string;
  session_id?: string;
}

export interface ChatResponse {
  response: string;
  agent_type: string;
  version: string;
  user_id: string;
  session_id?: string;
}

export interface SystemStatusResponse {
  is_initialized: boolean;
  version: string;
  available_agents: string[];
  external_services: Record<string, boolean>;
}

class AIAgentAPI {
  // 与留学规划师对话
  async chatWithPlanner(request: ChatRequest): Promise<ChatResponse> {
    const response = await apiRequest('/api/v2/agents/planner/chat', {
      method: 'POST',
      body: JSON.stringify(request)
    });
    return response.json();
  }

  // 与留学咨询师对话
  async chatWithConsultant(request: ChatRequest): Promise<ChatResponse> {
    const response = await apiRequest('/api/v2/agents/consultant/chat', {
      method: 'POST',
      body: JSON.stringify(request)
    });
    return response.json();
  }

  // 获取系统状态
  async getSystemStatus(): Promise<SystemStatusResponse> {
    const response = await apiRequest('/api/v2/agents/status');
    return response.json();
  }

  // 健康检查
  async healthCheck(): Promise<any> {
    const response = await apiRequest('/api/v2/agents/health');
    return response.json();
  }
}

export const aiAgentAPI = new AIAgentAPI();
```

#### 2. **智能匹配系统 API客户端**

```typescript
// web/app/_lib/matching-api.ts
export interface MatchingRequest {
  target_universities: string[];
  target_majors: string[];
  preferred_degree: string;
  budget_range: [number, number];
  preferred_languages: string[];
  session_type: string;
  timeline: string;
  special_requirements?: string;
}

export interface MatchingResult {
  request_id: string;
  student_id: number;
  total_matches: number;
  matches: MentorMatch[];
  filters_applied: MatchingRequest;
  created_at: string;
}

export interface MentorMatch {
  mentor_id: number;
  mentor_name: string;
  university: string;
  major: string;
  match_score: number;
  match_reasons: string[];
  hourly_rate: number;
  rating: number;
  total_sessions: number;
}

class MatchingAPI {
  // 推荐引路人
  async recommendMentors(request: MatchingRequest): Promise<MatchingResult> {
    const response = await apiRequest('/api/v1/matching/recommend', {
      method: 'POST',
      body: JSON.stringify(request)
    });
    return response.json();
  }

  // 获取筛选条件
  async getFilters(): Promise<any> {
    const response = await apiRequest('/api/v1/matching/filters');
    return response.json();
  }

  // 获取匹配历史
  async getMatchingHistory(): Promise<MatchingResult[]> {
    const response = await apiRequest('/api/v1/matching/history');
    return response.json();
  }

  // 保存匹配结果
  async saveMatch(mentorId: number): Promise<void> {
    await apiRequest('/api/v1/matching/save', {
      method: 'POST',
      body: JSON.stringify({ mentor_id: mentorId })
    });
  }
}

export const matchingAPI = new MatchingAPI();
```

#### 3. **文件上传 API客户端**

```typescript
// web/app/_lib/file-upload-api.ts
export interface FileUploadResponse {
  file_id: string;
  filename: string;
  original_filename: string;
  file_url: string;
  file_size: number;
  content_type: string;
  uploaded_at: string;
}

class FileUploadAPI {
  // 上传头像
  async uploadAvatar(file: File): Promise<FileUploadResponse> {
    const formData = new FormData();
    formData.append('file', file);

    const token = getAuthToken();
    const response = await fetch('/api/v1/files/upload/avatar', {
      method: 'POST',
      headers: {
        ...(token && { Authorization: `Bearer ${token}` })
      },
      body: formData
    });

    if (!response.ok) {
      throw new Error('Failed to upload avatar');
    }

    return response.json();
  }

  // 上传文档
  async uploadDocument(
    file: File,
    description?: string
  ): Promise<FileUploadResponse> {
    const formData = new FormData();
    formData.append('file', file);
    if (description) {
      formData.append('description', description);
    }

    const token = getAuthToken();
    const response = await fetch('/api/v1/files/upload/document', {
      method: 'POST',
      headers: {
        ...(token && { Authorization: `Bearer ${token}` })
      },
      body: formData
    });

    if (!response.ok) {
      throw new Error('Failed to upload document');
    }

    return response.json();
  }

  // 删除文件
  async deleteFile(fileId: string): Promise<void> {
    await apiRequest(`/api/v1/files/${fileId}`, {
      method: 'DELETE'
    });
  }
}

export const fileUploadAPI = new FileUploadAPI();
```

### 方案二：更新API配置文件

#### 更新 `web/app/_lib/api-config.ts`

```typescript
export const API_CONFIG = {
  BASE_URL: process.env.NEXT_PUBLIC_API_BASE_URL || 'http://localhost:8000',

  ENDPOINTS: {
    // 现有的保持不变...

    // 🤖 AI智能体系统 v2.0 (新增)
    AI_AGENTS_V2: {
      STATUS: '/api/v2/agents/status',
      INFO: '/api/v2/agents/info',
      HEALTH: '/api/v2/agents/health',
      PLANNER_CHAT: '/api/v2/agents/planner/chat',
      CONSULTANT_CHAT: '/api/v2/agents/consultant/chat',
      CHAT: '/api/v2/agents/chat',
      PLANNER_INVOKE: '/api/v2/agents/planner/invoke'
    },

    // 🎯 智能匹配系统 (新增)
    MATCHING: {
      RECOMMEND: '/api/v1/matching/recommend',
      FILTERS: '/api/v1/matching/filters',
      FILTER: '/api/v1/matching/filter',
      HISTORY: '/api/v1/matching/history',
      SAVE: '/api/v1/matching/save',
      SAVED: '/api/v1/matching/saved',
      STATS: '/api/v1/matching/stats',
      COMPATIBILITY: '/api/v1/matching/compatibility'
    },

    // 📁 文件上传系统 (新增)
    FILES: {
      UPLOAD_AVATAR: '/api/v1/files/upload/avatar',
      UPLOAD_DOCUMENT: '/api/v1/files/upload/document',
      UPLOAD_GENERAL: '/api/v1/files/upload/general',
      DELETE: (fileId: string) => `/api/v1/files/${fileId}`
    },

    // 完善现有的端点
    MENTORS: {
      // 现有的保持...
      REGISTER: '/api/v1/mentors/register', // 新增
      LIST: '/api/v1/mentors', // 新增
      BY_ID: (id: number) => `/api/v1/mentors/${id}`, // 新增
      UPDATE: (id: number) => `/api/v1/mentors/${id}`, // 新增
      SEARCH: '/api/v1/mentors/search',
      PROFILE: '/api/v1/mentors/profile'
    },

    STUDENTS: {
      REGISTER: '/api/v1/students/register', // 新增
      BY_ID: (id: number) => `/api/v1/students/${id}`, // 新增
      UPDATE: (id: number) => `/api/v1/students/${id}`, // 新增
      DELETE: (id: number) => `/api/v1/students/${id}`, // 新增
      PROFILE: '/api/v1/students/profile'
    },

    SERVICES: {
      CREATE: '/api/v1/services', // 新增
      LIST: '/api/v1/services', // 新增
      BY_ID: (id: number) => `/api/v1/services/${id}`, // 新增
      UPDATE: (id: number) => `/api/v1/services/${id}`, // 新增
      DELETE: (id: number) => `/api/v1/services/${id}`, // 新增
      ORDERS: {
        MY_ORDERS: '/api/v1/services/orders/my-orders'
      }
    },

    SESSIONS: {
      CREATE: '/api/v1/sessions', // 新增
      LIST: '/api/v1/sessions',
      BY_ID: (id: number) => `/api/v1/sessions/${id}`, // 新增
      UPDATE: (id: number) => `/api/v1/sessions/${id}`, // 新增
      DELETE: (id: number) => `/api/v1/sessions/${id}`, // 新增
      STATISTICS: '/api/v1/sessions/statistics'
    },

    REVIEWS: {
      CREATE: '/api/v1/reviews', // 新增
      LIST: '/api/v1/reviews', // 新增
      BY_ID: (id: number) => `/api/v1/reviews/${id}`, // 新增
      UPDATE: (id: number) => `/api/v1/reviews/${id}`, // 新增
      DELETE: (id: number) => `/api/v1/reviews/${id}`, // 新增
      MY_REVIEWS: '/api/v1/reviews/my-reviews'
    }
  }
} as const;
```

---

## 📝 **实施计划**

### 阶段一：核心功能修复 (1-2天)

1. ✅ 实现AI智能体v2.0 API客户端
2. ✅ 更新认证和状态管理以支持AI对话
3. ✅ 创建AI对话界面组件

### 阶段二：智能匹配系统 (2-3天)

1. ✅ 实现匹配API客户端
2. ✅ 创建匹配界面和结果展示
3. ✅ 集成筛选和保存功能

### 阶段三：文件管理系统 (1-2天)

1. ✅ 实现文件上传API
2. ✅ 创建文件上传组件
3. ✅ 集成头像上传功能

### 阶段四：完善其他模块 (3-4天)

1. ✅ 补全引路人和申请者管理
2. ✅ 完善服务和会话管理
3. ✅ 实现评价反馈系统

---

## 🎯 **立即行动建议**

### 优先级排序：

1. **🔥 紧急** - AI智能体v2.0接口 (核心功能)
2. **⚡ 高** - 智能匹配系统 (核心业务逻辑)
3. **📱 中** - 文件上传系统 (用户体验)
4. **🔧 低** - 其他模块补全 (功能完善)

### 技术实施：

1. 参考 [freeCodeCamp的RESTful API集成指南](https://www.freecodecamp.org/news/how-work-with-restful-apis-in-react-simplified-steps-and-practical-examples)
2. 使用现有的TypeScript和Zustand架构
3. 保持与现有API客户端的一致性
4. 添加适当的错误处理和加载状态

### 测试策略：

1. 单元测试每个API客户端方法
2. 集成测试完整的用户流程
3. 端到端测试核心功能路径

---

## 💡 **额外建议**

### 代码组织优化：

```
web/app/_lib/
├── api/
│   ├── ai-agent-api.ts      # AI智能体
│   ├── matching-api.ts      # 智能匹配
│   ├── file-upload-api.ts   # 文件上传
│   ├── mentor-api.ts        # 引路人管理
│   ├── student-api.ts       # 申请者管理
│   ├── service-api.ts       # 服务管理
│   └── index.ts             # 统一导出
├── api-config.ts
├── auth.ts
└── utils.ts
```

### 环境配置：

```bash
# .env.local
NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
NEXT_PUBLIC_AI_AGENT_TIMEOUT=30000
NEXT_PUBLIC_FILE_UPLOAD_MAX_SIZE=10485760
```

---

**⚡ 总结：前端急需实现AI智能体v2.0和智能匹配系统的接口对接，这是平台核心功能！**
